{% extends 'base2.html.twig' %}

{% block title %}Historique des préparations{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .pagination {
        margin-bottom: 0;
    }

    .page-link {
        padding: 0.5rem 0.75rem;
        color: #2196f3;
        background-color: #fff;
        border: 1px solid #dee2e6;
    }

    .page-item.active .page-link {
        background-color: #2196f3;
        border-color: #2196f3;
        color: #fff;
    }

    .page-item.disabled .page-link {
        color: #6c757d;
        pointer-events: none;
        background-color: #fff;
        border-color: #dee2e6;
    }

    .pagination-rounded .page-link {
        margin: 0 2px;
        border-radius: 0.25rem;
    }

    .card {
        margin-bottom: 1rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }

    .btn-info {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block body %}
    <div class="container-fluid py-4">
        {# Formulaire de recherche #}
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="mb-0">Filtres de recherche</h3>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-2">
                        <label for="dateDebut" class="form-label">Date début</label>
                        <input type="date" class="form-control" id="dateDebut" name="dateDebut" value="{{ filtres.dateDebut }}">
                    </div>
                    <div class="col-md-2">
                        <label for="dateFin" class="form-label">Date fin</label>
                        <input type="date" class="form-control" id="dateFin" name="dateFin" value="{{ filtres.dateFin }}">
                    </div>
                    <div class="col-md-2">
                        <label for="codeClient" class="form-label">Code client</label>
                        <input type="text" class="form-control" id="codeClient" name="codeClient" value="{{ filtres.codeClient }}">
                    </div>
                    <div class="col-md-2">
                        <label for="client" class="form-label">Client</label>
                        <input type="text" class="form-control" id="client" name="client" value="{{ filtres.client }}">
                    </div>
                    <div class="col-md-2">
                        <label for="preparateur" class="form-label">Préparateur</label>
                        <input type="text" class="form-control" id="preparateur" name="preparateur" value="{{ filtres.preparateur }}">
                    </div>
                    <div class="col-md-2">
                        <label for="noBl" class="form-label">N° BL</label>
                        <input type="text" class="form-control" id="noBl" name="noBl" value="{{ filtres.noBl }}">
                    </div>
                    <div class="col-md-4">
                        <label for="codeProduits" class="form-label">Codes Produits (séparés par des virgules)</label>
                        <input type="text" class="form-control" id="codeProduits" name="codeProduits" 
                               value="{{ filtres.codeProduits }}" placeholder="Ex: CODE1, CODE2, CODE3">
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Rechercher</button>
                        <a href="{{ path('app_historique_suivi_preparation') }}" class="btn btn-secondary">Réinitialiser</a>
                        <a href="{{ path('app_historique_suivi_preparation_export', filtres) }}" class="btn btn-success">
                            Exporter en CSV
                        </a>
                    </div>
                </form>
            </div>
        </div>

        {# Statistiques #}
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Total préparations</h5>
                        <p class="card-text h3">{{ stats.total|number_format(0, ',', ' ') }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Libre</h5>
                       
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Libre</h5>
                       
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Libre</h5>
                        
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Libre</h5>
                        
                    </div>
                </div>
            </div>
        </div>

        {# Tableau des résultats #}
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">Résultats ({{ pagination.getTotalItemCount }} enregistrements)</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>{{ knp_pagination_sortable(pagination, 'Date', 's.updatedAt') }}</th>
                                 <th>{{ knp_pagination_sortable(pagination, 'Ref', 's.code_produit') }}</th>
                                <th>{{ knp_pagination_sortable(pagination, 'Code Client', 's.Code_Client') }}</th>
                                <th>{{ knp_pagination_sortable(pagination, 'Client', 's.Client') }}</th>
                                <th>{{ knp_pagination_sortable(pagination, 'Préparateur', 's.Preparateur') }}</th>
                                <th>{{ knp_pagination_sortable(pagination, 'N° BL', 's.No_Bl') }}</th>
                                <th>{{ knp_pagination_sortable(pagination, 'N° Commande', 's.No_Cmd') }}</th>
                                <th>{{ knp_pagination_sortable(pagination, 'Statut', 's.Statut_Cde') }}</th>
                                <th>{{ knp_pagination_sortable(pagination, 'Zone', 's.Zone') }}</th>

                                <th>Date livraison</th>
                                <th>Transporteur</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for suivi in pagination %}
                                <tr>
                                    <td>{{ suivi.updatedAt|date('d/m/Y') }}</td>
                                    <td>{{ suivi.CodeProduit }}</td>
                                    <td>{{ suivi.CodeClient }}</td>
                                    <td>{{ suivi.Client }}</td>
                                    <td>{{ suivi.Preparateur }}</td>
                                    <td>{{ suivi.NoBl }}</td>
                                    <td>{{ suivi.NoCmd }}</td>
                                    <td>{{ suivi.StatutCde }}</td>
                                    <td>{{ suivi.Zone }}</td>
                                    <td>{{ suivi.dateLiv|date('d/m/Y') }}</td>
                                    <td>{{ suivi.Transporteur }}</td>
                                    <td>
                                        <a href="{{ path('app_historique_suivi_preparation_detail', {'id': suivi.id}) }}" 
                                           class="btn btn-sm btn-info">
                                            Détails
                                        </a>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="14" class="text-center">Aucun résultat trouvé</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="navigation d-flex justify-content-center mt-3">
                    {% if pagination.pageCount > 1 %}
                        <nav aria-label="Pagination">
                            <ul class="pagination pagination-rounded">
                                {# Bouton Previous #}
                                {% if pagination.currentPageNumber > 1 %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ path(app.request.attributes.get('_route'), 
                                            app.request.query.all|merge({page: pagination.currentPageNumber - 1})) }}" rel="prev">«</a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">«</span>
                                    </li>
                                {% endif %}

                                {# Première page #}
                                {% if pagination.currentPageNumber > 3 %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ path(app.request.attributes.get('_route'), 
                                            app.request.query.all|merge({page: 1})) }}">1</a>
                                    </li>
                                    {% if pagination.currentPageNumber > 4 %}
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    {% endif %}
                                {% endif %}

                                {# Pages numérotées #}
                                {% for page in max(1, pagination.currentPageNumber - 1)..min(pagination.pageCount, pagination.currentPageNumber + 2) %}
                                    {% if page == pagination.currentPageNumber %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page }}</span>
                                        </li>
                                    {% else %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ path(app.request.attributes.get('_route'), 
                                                app.request.query.all|merge({page: page})) }}">{{ page }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {# Dernière page #}
                                {% if pagination.currentPageNumber < pagination.pageCount - 2 %}
                                    {% if pagination.currentPageNumber < pagination.pageCount - 3 %}
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                    {% endif %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ path(app.request.attributes.get('_route'), 
                                            app.request.query.all|merge({page: pagination.pageCount})) }}">{{ pagination.pageCount }}</a>
                                    </li>
                                {% endif %}

                                {# Bouton Next #}
                                {% if pagination.currentPageNumber < pagination.pageCount %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ path(app.request.attributes.get('_route'), 
                                            app.request.query.all|merge({page: pagination.currentPageNumber + 1})) }}" rel="next">»</a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">»</span>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}