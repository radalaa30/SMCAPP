{# Partiel réutilisable pour NEW & EDIT #}
{# Variables attendues :
   - form (FormView)
   - submit_label (string) optionnel
   - back_path (string) optionnel
#}

{% set submit_label = submit_label ?? 'Enregistrer' %}
{% set back_path = back_path ?? path('admin_users_index') %}

{{ form_start(form) }}

<div class="card shadow-sm mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <i class="fas fa-user-cog me-2"></i> Informations utilisateur
    </h5>
    <a href="{{ back_path }}" class="btn btn-outline-secondary btn-sm">
      <i class="fas fa-arrow-left"></i> Retour
    </a>
  </div>

  <div class="card-body">
    {# erreurs globales #}
    {% if form_errors(form) %}
      <div class="alert alert-danger">
        {{ form_errors(form) }}
      </div>
    {% endif %}

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label"><i class="fas fa-user me-1"></i> Nom d’utilisateur</label>
        {{ form_widget(form.username, {'attr': {'class': 'form-control', 'placeholder':'ex: jdupond'}}) }}
        <div class="form-text text-muted">{{ form_errors(form.username) }}</div>
      </div>

      <div class="col-md-6">
        <label class="form-label"><i class="fas fa-envelope me-1"></i> Email</label>
        {{ form_widget(form.email, {'attr': {'class': 'form-control', 'placeholder':'ex: jdupond@exemple.com'}}) }}
        <div class="form-text text-muted">{{ form_errors(form.email) }}</div>
      </div>

      <div class="col-md-6">
        <label class="form-label"><i class="fas fa-user-shield me-1"></i> Rôles</label>
        {# rendu automatique (checkboxes ou multiselect selon UserType) #}
        {{ form_widget(form.roles, {'attr': {'class': 'form-control'}}) }}
        <div class="form-text">
          <small class="text-muted">
            <i class="fas fa-info-circle"></i> L’utilisateur possède toujours <code>ROLE_USER</code> par défaut.
          </small>
        </div>
        <div class="form-text text-muted">{{ form_errors(form.roles) }}</div>
      </div>

      <div class="col-md-6">
        <label class="form-label">
          <i class="fas fa-key me-1"></i>
          Mot de passe
          <small class="text-muted">
            {% if form.plainPassword is defined %}
              {% if form.plainPassword.vars.required %}(obligatoire){% else %}(laisser vide pour ne pas changer){% endif %}
            {% else %}
              {% if form.password is defined and form.password.vars.required %}(obligatoire){% else %}(laisser vide pour ne pas changer){% endif %}
            {% endif %}
          </small>
        </label>

        <div class="input-group">
          {# On supporte plainPassword (recommandé) OU password si ton form ne l’a pas #}
          {% if form.plainPassword is defined %}
            {{ form_widget(form.plainPassword, {'attr': {'class': 'form-control', 'autocomplete': 'new-password', 'id': 'user-password-field'}}) }}
          {% elseif form.password is defined %}
            {{ form_widget(form.password, {'attr': {'class': 'form-control', 'autocomplete': 'new-password', 'id': 'user-password-field'}}) }}
          {% endif %}
          <button class="btn btn-outline-secondary" type="button" id="togglePwdBtn" title="Afficher/Masquer">
            <i class="fas fa-eye"></i>
          </button>
        </div>
        <div class="form-text text-muted">
          {% if form.plainPassword is defined %}{{ form_errors(form.plainPassword) }}{% elseif form.password is defined %}{{ form_errors(form.password) }}{% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="card-footer d-flex justify-content-end gap-2">
    <a href="{{ back_path }}" class="btn btn-outline-secondary">
      <i class="fas fa-times"></i> Annuler
    </a>
    <button class="btn btn-primary">
      <i class="fas fa-save"></i> {{ submit_label }}
    </button>
  </div>
</div>

{{ form_end(form) }}

{# Toggle password #}
<script>
  (function() {
    const btn = document.getElementById('togglePwdBtn');
    const input = document.getElementById('user-password-field');
    if (!btn || !input) return;

    btn.addEventListener('click', function() {
      const isPwd = input.getAttribute('type') === 'password';
      input.setAttribute('type', isPwd ? 'text' : 'password');
      this.innerHTML = isPwd ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
    });
  })();
</script>
