{% extends 'base2.html.twig' %}

{% block title %}Gestion des KO (Flasher = KO){% endblock %}

{% block body %}
<h1>Gestion des KO</h1>

<form method="get" class="mb-3" style="display:grid; grid-template-columns: repeat(6, 1fr); gap: .75rem;">
  <input type="text" name="codeProduit" value="{{ filters.codeProduit }}" placeholder="Code produit" class="form-control">
  <input type="text" name="client" value="{{ filters.client }}" placeholder="Client" class="form-control">
  <input type="text" name="preparateur" value="{{ filters.preparateur }}" placeholder="Préparateur" class="form-control">
  <input type="date" name="dateFrom" value="{{ filters.dateFrom ? filters.dateFrom|date('Y-m-d') : '' }}" class="form-control">
  <input type="date" name="dateTo" value="{{ filters.dateTo ? filters.dateTo|date('Y-m-d') : '' }}" class="form-control">
  <div>
    <select name="limit" class="form-select">
      {% for n in [10,25,50,100] %}
        <option value="{{ n }}" {{ limit == n ? 'selected' : '' }}>{{ n }}/page</option>
      {% endfor %}
    </select>
  </div>
  <div style="grid-column: span 6;">
    <button class="btn btn-primary">Filtrer</button>
    <a class="btn btn-secondary" href="{{ path('ko_index') }}">Réinitialiser</a>
    <a class="btn btn-success" href="{{ path('ko_export_csv', app.request.query.all) }}">Exporter CSV</a>
  </div>
</form>

<div class="table-responsive">
<table class="table table-striped table-sm align-middle">
  <thead>
    <tr>
      <th>CodeProduit</th>
      <th>Client</th>
      <th>No_Bl</th>
      <th>Préparateur</th>
      <th>No Palette</th>
      <th>Zone</th>
      <th>Adresse</th>
      <th>Nb_art</th>
      <th>No_Cmd</th>
      <th>Code_Client</th>
      <th>Statut KO</th>
      <th>Cause</th>
      <th>MAJ</th>
      <th>Détail</th>
    </tr>
  </thead>
  <tbody>
    {% for r in items %}
      {% set lastRow = last[r.id] ?? null %}
      <tr>
        <td>{{ r.codeProduit }}</td>
        <td>{{ r.client }}</td>
        <td>{{ r.noBl }}</td>
        <td>{{ r.preparateur }}</td>
        <td>{{ r.noPal }}</td>
        <td>{{ r.zone }}</td>
        <td>{{ r.adresse }}</td>
        <td>{{ r.nbArt }}</td>
        <td>{{ r.noCmd }}</td>
        <td>{{ r.codeClient }}</td>

        <td>
          {% if lastRow %}
            {% set badge = {
              'NOUVEAU':'bg-danger',
              'EN_COURS':'bg-warning text-dark',
              'TRAITE':'bg-success',
              'REJETE':'bg-secondary'
            }[lastRow.statut] ?? 'bg-light text-dark' %}
            <span class="badge {{ badge }}">{{ lastRow.statut }}</span>
            {% if lastRow.traite %}<span class="badge bg-success ms-1">Traité</span>{% endif %}
          {% else %}
            <span class="badge bg-danger">NOUVEAU</span>
          {% endif %}
        </td>

        <td>{{ lastRow ? lastRow.cause : '' }}</td>

        <td>{{ r.updatedAt ? r.updatedAt|date('Y-m-d H:i') : '' }}</td>
        <td><a class="btn btn-outline-primary btn-sm" href="{{ path('ko_show', {id: r.id}) }}">Voir</a></td>
      </tr>
    {% else %}
      <tr><td colspan="20" class="text-center">Aucun KO trouvé.</td></tr>
    {% endfor %}
  </tbody>
</table>
</div>

{% set totalPages = (total / limit)|round(0, 'ceil') %}
{% if totalPages > 1 %}
<nav>
  <ul class="pagination">
    {% for p in 1..totalPages %}
      {% set params = app.request.query.all | merge({'page': p}) %}
      <li class="page-item {{ p == page ? 'active' : '' }}">
        <a class="page-link" href="{{ path('ko_index', params) }}">{{ p }}</a>
      </li>
    {% endfor %}
  </ul>
</nav>
{% endif %}

<p class="text-muted">Total : {{ total }} KO</p>
{% endblock %}
