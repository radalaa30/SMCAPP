{# templates/emplacement/index.html.twig #}

{% extends 'base2.html.twig' %}

{% block title %}Visualisation des emplacements{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        :root {
            --rack-blue: #4472C4;
            --rack-border: #305496;
            --free-space: white;
            --occupied-space: #92D050;
            --blocked-space: #FF0000;
            --header-orange: #FFC000;
            --en-sortie: #FF99CC;
            --probleme-color: #8B0000;  /* Rouge foncé pour les problèmes */
        }
        
        body { background-color: #f5f7fa; }
        .container-emplacements { margin-top: 20px; overflow-x: auto; padding: 10px; }
        .form-selection { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .cellule-vue { border: 2px solid #000; padding: 20px; margin-bottom: 30px; background-color: #fff; }
        .cellule-header { background-color: #343a40; color: white; padding: 12px; font-weight: bold; text-align: center; margin-bottom: 20px; font-size: 1.2rem; }
        .allee-content { display: flex; flex-direction: column; }
        .cote-container { margin-bottom: 20px; }
        .cote-label { background-color: #E7E6E6; padding: 8px; font-weight: bold; text-align: left; border: 1px solid #000; margin-bottom: 0; }
        .positions-row { display: flex; flex-direction: row; border-left: 2px solid #000; border-right: 2px solid #000; }
        .position-group { display: flex; flex-direction: row; border-right: 2px solid var(--rack-blue); }
        .position-group:last-child { border-right: none; }
        .position-column { display: flex; flex-direction: column; width: 100px; }
        .position-header { height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; background-color: var(--header-orange); border: 1px solid #000; border-top: 2px solid #000; border-bottom: 1px solid #000; font-size: 0.9rem; }
        .niveau-cell { height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #000; font-size: 13px; font-weight: bold; position: relative; padding: 3px; cursor: pointer; transition: all 0.3s ease; }
        .niveau-cell:hover { transform: scale(1.02); box-shadow: 0 0 8px rgba(0,0,0,0.3); z-index: 10; }
        .niveau-info { font-size: 10px; font-weight: normal; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center; }
        .vide { background-color: var(--free-space); }
        .plein { background-color: var(--occupied-space); color: black; }
        .plein.multiple { background-color: #1B6E1B; color: white; }
        .rouge { background-color: var(--blocked-space); color: white; }
        .enSortie { background-color: var(--en-sortie); color: black; }
        .enSortie.multiple { background-color: #CC5283; color: white; }
        .probleme { background-color: var(--probleme-color); color: white; border: 3px solid #FFD700; }
        .probleme:hover { border-color: #FFA500; }
        .probleme-icon { position: absolute; top: 2px; right: 2px; color: #FFD700; font-size: 14px; }
        .bleu { background-color: var(--rack-blue); color: white; }
        .info-box { display: none; position: absolute; background-color: #343a40; color: white; border: 1px solid #adb5bd; border-radius: 5px; padding: 12px; z-index: 100; width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.35); left: 105px; top: 0; }
        .niveau-cell:hover .info-box { display: block; }
        .legende { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-top: 20px; }
        .info-box strong { color: #ffc107; font-weight: bold; }
        .info-box p { margin-bottom: 6px; font-size: 14px; line-height: 1.4; }
        .legende-item { display: flex; align-items: center; margin-bottom: 8px; }
        .legende-couleur { width: 25px; height: 25px; margin-right: 12px; border: 1px solid #adb5bd; border-radius: 3px; }
        .legende-couleur.rack { background-color: var(--rack-blue); }
        .legende-couleur.orange { background-color: var(--header-orange); }
        .legende-couleur.enSortie { background-color: var(--en-sortie); }
        .legende-couleur.probleme { background-color: var(--probleme-color); border: 3px solid #FFD700; }
        .niveau-adresse { font-size: 11px; font-weight: normal; color: #666; position: absolute; bottom: 2px; right: 2px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 50%; border-radius: 8px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .historique-btn { position: fixed; bottom: 20px; right: 20px; background-color: #007bff; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 999; }
        .historique-btn:hover { background-color: #0056b3; color: white; text-decoration: none; }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const celluleSelect = document.getElementById('cellule');
            const alleeSelect = document.getElementById('allee');
            
            celluleSelect.addEventListener('change', function() {
                document.getElementById('form-selection').submit();
            });
            
            alleeSelect.addEventListener('change', function() {
                document.getElementById('form-selection').submit();
            });
            
            // Gestion du modal
            const modal = document.getElementById('problemModal');
            const span = document.getElementsByClassName('close')[0];
            span.onclick = function() { modal.style.display = 'none'; }
            window.onclick = function(event) { if (event.target == modal) modal.style.display = 'none'; }
            
            // Clic sur tous les emplacements
            document.querySelectorAll('.niveau-cell').forEach(function(cell) {
                cell.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const emplacement = this.dataset.emplacement;
                    document.getElementById('problemEmplacement').value = emplacement;
                    modal.style.display = 'block';
                });
            });
            
            // Envoi du signalement
            document.getElementById('problemForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const emplacement = document.getElementById('problemEmplacement').value;
                const description = document.getElementById('problemDescription').value;
                
                fetch('{{ path('app_probleme_signaler') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ emplacement, description })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const cell = document.querySelector(`.niveau-cell[data-emplacement="${emplacement}"]`);
                        if (cell) {
                            cell.classList.add('probleme');
                            if (!cell.querySelector('.probleme-icon')) {
                                const icon = document.createElement('i');
                                icon.className = 'fas fa-exclamation-triangle probleme-icon';
                                cell.appendChild(icon);
                            }
                        }
                        alert('Problème signalé avec succès');
                        modal.style.display = 'none';
                        document.getElementById('problemDescription').value = '';
                    } else {
                        alert('Erreur lors du signalement');
                    }
                })
                .catch(() => alert('Erreur lors du signalement'));
            });
        });
    </script>
{% endblock %}

{% block body %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <h1 class="my-4">Visualisation des emplacements</h1>
                
                <div class="form-selection">
                    <form id="form-selection" method="get">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="cellule">Cellule:</label>
                                    <select id="cellule" name="cellule" class="form-control">
                                        {% for code, data in cellules %}
                                            <option value="{{ code }}" {% if code == celluleSelectionnee %}selected{% endif %}>
                                                Cellule {{ code }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="allee">Allée:</label>

                                    {# --- AJOUT ICI : si cellule C4, on ajoute F, G, H aux allées proposées --- #}
                                    {% set alleesToShow = cellules[celluleSelectionnee].allees %}
                                    {% if celluleSelectionnee in ['C4','4'] %}
                                        {% set alleesToShow = alleesToShow|merge(['F','G','H']) %}
                                    {% endif %}

                                    {# (optionnel) suppression des doublons #}
                                    {% set _dict = {} %}
                                    {% for a in alleesToShow %}
                                        {% set _dict = _dict|merge({ (a): true }) %}
                                    {% endfor %}
                                    {% set alleesToShow = _dict|keys|sort %}

                                    <select id="allee" name="allee" class="form-control">
                                        {% for alleeCode in alleesToShow %}
                                            <option value="{{ alleeCode }}" {% if alleeCode == alleeSelectionnee %}selected{% endif %}>
                                                Allée {{ alleeCode }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="cellule-vue">
                    <div class="cellule-header">
                        Cellule: {{ celluleSelectionnee }} - Allée: {{ alleeSelectionnee }}
                    </div>
                    
                    <div class="container-emplacements">
                        <div class="allee-content">
                            <!-- CÔTÉ PAIR (EN HAUT) -->
                            <div class="cote-container">
                                <div class="cote-label">{{ celluleSelectionnee }} - Côté Pair</div>
                                <div class="positions-row">
                                    {% set positionsPair = [] %}
                                    {% for position, niveaux in emplacements.droite %}
                                        {% set positionsPair = positionsPair|merge([position]) %}
                                    {% endfor %}
                                    
                                    {% if positionsPair|length > 0 %}
                                        {% set positionsPair = positionsPair|sort %}
                                        
                                        {% for chunkStart in range(0, positionsPair|length, 4) %}
                                            <div class="position-group">
                                                {% for i in range(chunkStart, chunkStart + 3) %}
                                                    {% if i < positionsPair|length %}
                                                        {% set position = positionsPair[i] %}
                                                        <div class="position-column">
                                                            {% set paddedPosition = position < 10 ? '0' ~ position : position %}
                                                            
                                                            {% for niveau in 4..0 %}
                                                                {% if emplacements.droite[position] is defined and emplacements.droite[position][niveau] is defined %}
                                                                    {% set infos = emplacements.droite[position][niveau] %}
                                                                    <div class="niveau-cell {% if infos.probleme %}probleme{% elseif infos.enSortie %}enSortie{% if infos.multiple %} multiple{% endif %}{% elseif infos.rouge %}rouge{% elseif infos.plein %}plein{% if infos.multiple %} multiple{% endif %}{% else %}vide{% endif %}"
                                                                         data-emplacement="{{ infos.code }}">
                                                                        {% if infos.probleme %}
                                                                            <i class="fas fa-exclamation-triangle probleme-icon"></i>
                                                                        {% endif %}
                                                                        {% if infos.plein %}
                                                                            <strong>{{ infos.uvtotal }}</strong>
                                                                            <div class="niveau-info">{{ infos.designation[0]|length > 12 ? infos.designation[0]|slice(0, 12) ~ '...' : infos.designation[0] }}</div>
                                                                            {% if infos.multiple %}
                                                                                <div class="niveau-info">({{ infos.count }} pal.)</div>
                                                                            {% endif %}
                                                                        {% else %}
                                                                            <span class="niveau-adresse">{{ position }}-{{ niveau }}</span>
                                                                        {% endif %}
                                                                        
                                                                        {% if infos.plein %}
                                                                            <div class="info-box">
                                                                                <p><strong>Emplacement:</strong> {{ infos.code }}</p>
                                                                                {% if infos.multiple %}
                                                                                    <p><strong>Nombre de palettes:</strong> {{ infos.count }}</p>
                                                                                    <p><strong>Palettes:</strong></p>
                                                                                    {% for i in 0..infos.nopal|length - 1 %}
                                                                                        <div style="margin-left: 10px; border-left: 2px solid #ffc107; padding-left: 10px; margin-bottom: 10px;">
                                                                                            <p>Palette {{ i + 1 }}:</p>
                                                                                            <p>- N° Palette: {{ infos.nopal[i] }}</p>
                                                                                            <p>- Produit: {{ infos.codeprod[i] }}</p>
                                                                                            <p>- Désignation: {{ infos.designation[i] }}</p>
                                                                                        </div>
                                                                                    {% endfor %}
                                                                                    <p><strong>UV total cumulé:</strong> {{ infos.uvtotal }}</p>
                                                                                    <p><strong>UC total cumulé:</strong> {{ infos.ucdispo }}</p>
                                                                                    <p><strong>UR total cumulé:</strong> {{ infos.urdispo }}</p>
                                                                                    <p><strong>UV en sortie cumulé:</strong> {{ infos.uvensortie }}</p>
                                                                                {% else %}
                                                                                    <p><strong>Palette:</strong> {{ infos.nopal[0] }}</p>
                                                                                    <p><strong>Produit:</strong> {{ infos.codeprod[0] }}</p>
                                                                                    <p><strong>Désignation:</strong> {{ infos.designation[0] }}</p>
                                                                                    <p><strong>UV total:</strong> {{ infos.uvtotal }}</p>
                                                                                    <p><strong>UC disponible:</strong> {{ infos.ucdispo }}</p>
                                                                                    <p><strong>UR disponible:</strong> {{ infos.urdispo }}</p>
                                                                                    <p><strong>UV en sortie:</strong> {{ infos.uvensortie }}</p>
                                                                                {% endif %}
                                                                                {% if infos.probleme %}
                                                                                    <p><strong class="text-danger">⚠️ Problème signalé</strong></p>
                                                                                {% endif %}
                                                                            </div>
                                                                        {% endif %}
                                                                    </div>
                                                                {% else %}
                                                                    <div class="niveau-cell vide" data-emplacement="{{ celluleSelectionnee }}:{{ alleeSelectionnee }}-{{ paddedPosition }}-{{ niveau }}">
                                                                        <span class="niveau-adresse">{{ position }}-{{ niveau }}</span>
                                                                    </div>
                                                                {% endif %}
                                                            {% endfor %}
                                                            <div class="position-header">{{ celluleSelectionnee }}:{{ alleeSelectionnee }}-{{ paddedPosition }}</div>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                                {% if chunkStart + 3 < positionsPair|length - 1 %}
                                                    <div class="position-column">
                                                        <div class="position-header"></div>
                                                        {% for niveau in 4..0 %}
                                                            <div class="niveau-cell bleu"></div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center py-3">
                                            <em>Aucun emplacement pair disponible</em>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- CÔTÉ IMPAIR (EN BAS) -->
                            <div class="cote-container">
                                <div class="cote-label">{{ celluleSelectionnee }} - Côté Impair</div>
                                <div class="positions-row">
                                    {% set positionsImpair = [] %}
                                    {% for position, niveaux in emplacements.gauche %}
                                        {% set positionsImpair = positionsImpair|merge([position]) %}
                                    {% endfor %}
                                    
                                    {% if positionsImpair|length > 0 %}
                                        {% set positionsImpair = positionsImpair|sort %}
                                        
                                        {% for chunkStart in range(0, positionsImpair|length, 4) %}
                                            <div class="position-group">
                                                {% for i in range(chunkStart, chunkStart + 3) %}
                                                    {% if i < positionsImpair|length %}
                                                        {% set position = positionsImpair[i] %}
                                                        <div class="position-column">
                                                            {% set paddedPosition = position < 10 ? '0' ~ position : position %}
                                                            
                                                            {% for niveau in 4..0 %}
                                                                {% if emplacements.gauche[position] is defined and emplacements.gauche[position][niveau] is defined %}
                                                                    {% set infos = emplacements.gauche[position][niveau] %}
                                                                    <div class="niveau-cell {% if infos.probleme %}probleme{% elseif infos.enSortie %}enSortie{% if infos.multiple %} multiple{% endif %}{% elseif infos.rouge %}rouge{% elseif infos.plein %}plein{% if infos.multiple %} multiple{% endif %}{% else %}vide{% endif %}"
                                                                         data-emplacement="{{ infos.code }}">
                                                                        {% if infos.probleme %}
                                                                            <i class="fas fa-exclamation-triangle probleme-icon"></i>
                                                                        {% endif %}
                                                                        {% if infos.plein %}
                                                                            <strong>{{ infos.uvtotal }}</strong>
                                                                            <div class="niveau-info">{{ infos.designation[0]|length > 12 ? infos.designation[0]|slice(0, 12) ~ '...' : infos.designation[0] }}</div>
                                                                            {% if infos.multiple %}
                                                                                <div class="niveau-info">({{ infos.count }} pal.)</div>
                                                                            {% endif %}
                                                                        {% else %}
                                                                            <span class="niveau-adresse">{{ position }}-{{ niveau }}</span>
                                                                        {% endif %}
                                                                        
                                                                        {% if infos.plein %}
                                                                            <div class="info-box">
                                                                                <p><strong>Emplacement:</strong> {{ infos.code }}</p>
                                                                                {% if infos.multiple %}
                                                                                    <p><strong>Nombre de palettes:</strong> {{ infos.count }}</p>
                                                                                    <p><strong>Palettes:</strong></p>
                                                                                    {% for i in 0..infos.nopal|length - 1 %}
                                                                                        <div style="margin-left: 10px; border-left: 2px solid #ffc107; padding-left: 10px; margin-bottom: 10px;">
                                                                                            <p>Palette {{ i + 1 }}:</p>
                                                                                            <p>- N° Palette: {{ infos.nopal[i] }}</p>
                                                                                            <p>- Produit: {{ infos.codeprod[i] }}</p>
                                                                                            <p>- Désignation: {{ infos.designation[i] }}</p>
                                                                                        </div>
                                                                                    {% endfor %}
                                                                                    <p><strong>UV total cumulé:</strong> {{ infos.uvtotal }}</p>
                                                                                    <p><strong>UC total cumulé:</strong> {{ infos.ucdispo }}</p>
                                                                                    <p><strong>UR total cumulé:</strong> {{ infos.urdispo }}</p>
                                                                                    <p><strong>UV en sortie cumulé:</strong> {{ infos.uvensortie }}</p>
                                                                                {% else %}
                                                                                    <p><strong>Palette:</strong> {{ infos.nopal[0] }}</p>
                                                                                    <p><strong>Produit:</strong> {{ infos.codeprod[0] }}</p>
                                                                                    <p><strong>Désignation:</strong> {{ infos.designation[0] }}</p>
                                                                                    <p><strong>UV total:</strong> {{ infos.uvtotal }}</p>
                                                                                    <p><strong>UC disponible:</strong> {{ infos.ucdispo }}</p>
                                                                                    <p><strong>UR disponible:</strong> {{ infos.urdispo }}</p>
                                                                                    <p><strong>UV en sortie:</strong> {{ infos.uvensortie }}</p>
                                                                                {% endif %}
                                                                                {% if infos.probleme %}
                                                                                    <p><strong class="text-danger">⚠️ Problème signalé</strong></p>
                                                                                {% endif %}
                                                                            </div>
                                                                        {% endif %}
                                                                    </div>
                                                                {% else %}
                                                                    <div class="niveau-cell vide" data-emplacement="{{ celluleSelectionnee }}:{{ alleeSelectionnee }}-{{ paddedPosition }}-{{ niveau }}">
                                                                        <span class="niveau-adresse">{{ position }}-{{ niveau }}</span>
                                                                    </div>
                                                                {% endif %}
                                                            {% endfor %}
                                                            <div class="position-header">{{ celluleSelectionnee }}:{{ alleeSelectionnee }}-{{ paddedPosition }}</div>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                                {% if chunkStart + 3 < positionsImpair|length - 1 %}
                                                    <div class="position-column">
                                                        <div class="position-header"></div>
                                                        {% for niveau in 4..0 %}
                                                            <div class="niveau-cell bleu"></div>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center py-3">
                                            <em>Aucun emplacement impair disponible</em>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="legende">
                    <h5>Légende</h5>
                    <div class="legende-item"><div class="legende-couleur vide"></div><span>Emplacement vide</span></div>
                    <div class="legende-item"><div class="legende-couleur plein"></div><span>Emplacement occupé (le chiffre indique UV total)</span></div>
                    <div class="legende-item"><div class="legende-couleur plein multiple"></div><span>Emplacement avec plusieurs palettes</span></div>
                    <div class="legende-item"><div class="legende-couleur rouge"></div><span>Palette bloquée</span></div>
                    <div class="legende-item"><div class="legende-couleur enSortie"></div><span>Palette en sortie</span></div>
                    <div class="legende-item"><div class="legende-couleur enSortie multiple"></div><span>Plusieurs palettes en sortie</span></div>
                    <div class="legende-item"><div class="legende-couleur probleme"></div><span>Problème signalé</span></div>
                    <div class="legende-item"><div class="legende-couleur rack"></div><span>Structure du rack</span></div>
                    <div class="legende-item"><div class="legende-couleur orange"></div><span>En-tête position</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal pour signaler un problème -->
    <div id="problemModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Signaler un problème</h3>
            <form id="problemForm">
                <div class="form-group">
                    <label for="problemEmplacement">Emplacement :</label>
                    <input type="text" id="problemEmplacement" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="problemDescription">Description du problème :</label>
                    <textarea id="problemDescription" class="form-control" rows="4" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary mt-3">Signaler</button>
            </form>
        </div>
    </div>
    
    <!-- Bouton vers l'historique des problèmes -->
    <a href="{{ path('app_problemes_liste') }}" class="historique-btn">
        <i class="fas fa-history"></i> Historique des problèmes
    </a>
{% endblock %}
