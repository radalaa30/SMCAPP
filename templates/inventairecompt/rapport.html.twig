{% extends 'inventairecompt/base.html.twig' %}

{% block title %}Rapport Inventaire{% endblock %}

{% block body %}
<div class="row">
    <div class="col-md-12">
        <h2><i class="fas fa-chart-bar me-2"></i>Rapport d'Inventaire</h2>
        <p class="text-muted">Totaux par code produit dans tous les emplacements</p>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Synthèse Inventaire</h5>
                <button class="btn btn-success btn-sm" onclick="exportToExcel()">
                    <i class="fas fa-file-excel me-1"></i>Exporter Excel
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="rapportTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Code Produit</th>
                                <th>Désignation</th>
                                <th>Nb Emplacements</th>
                                <th>Total UV</th>
                                <th>Total UR Dispo</th>
                                <th>Total UC Dispo</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set grandTotalUV = 0 %}
                            {% set grandTotalUR = 0 %}
                            {% set grandTotalUC = 0 %}
                            {% set totalEmplacements = 0 %}
                            
                            {% for item in rapport_data %}
                                {% set grandTotalUV = grandTotalUV + item.total_uvtotal %}
                                {% set grandTotalUR = grandTotalUR + item.total_urdispo %}
                                {% set grandTotalUC = grandTotalUC + item.total_ucdispo %}
                                {% set totalEmplacements = totalEmplacements + item.nb_emplacements %}
                                
                                <tr>
                                    <td>
                                        <strong class="text-primary">{{ item.codeprod }}</strong>
                                    </td>
                                    <td>{{ item.dsignprod }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ item.nb_emplacements }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success fs-6">{{ item.total_uvtotal }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning text-dark">{{ item.total_urdispo }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ item.total_ucdispo }}</span>
                                    </td>
                                    <td>
                                        <a href="{{ path('app_inventairecompt_search', {codeprod: item.codeprod}) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-search me-1"></i>Détails
                                        </a>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="fas fa-inbox me-2"></i>Aucune donnée disponible
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                        {% if rapport_data %}
                        <tfoot class="table-light">
                            <tr class="fw-bold">
                                <th colspan="2">TOTAUX GÉNÉRAUX:</th>
                                <th>
                                    <span class="badge bg-info fs-6">{{ totalEmplacements }}</span>
                                </th>
                                <th>
                                    <span class="badge bg-success fs-6">{{ grandTotalUV }}</span>
                                </th>
                                <th>
                                    <span class="badge bg-warning text-dark fs-6">{{ grandTotalUR }}</span>
                                </th>
                                <th>
                                    <span class="badge bg-secondary fs-6">{{ grandTotalUC }}</span>
                                </th>
                                <th></th>
                            </tr>
                        </tfoot>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% if rapport_data %}
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body text-center">
                <h4>{{ rapport_data|length }}</h4>
                <p class="mb-0">Codes Produits</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <h4>{{ totalEmplacements }}</h4>
                <p class="mb-0">Emplacements</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <h4>{{ grandTotalUV }}</h4>
                <p class="mb-0">Total UV</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <h4>{{ grandTotalUR }}</h4>
                <p class="mb-0">Total UR Dispo</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block javascripts %}
<script>
function exportToExcel() {
    // Simple export to CSV (can be opened in Excel)
    let csv = 'Code Produit,Désignation,Nb Emplacements,Total UV,Total UR Dispo,Total UC Dispo\n';
    
    const table = document.getElementById('rapportTable');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length > 0) {
            const data = [
                cells[0].textContent.trim(),
                cells[1].textContent.trim(),
                cells[2].textContent.trim(),
                cells[3].textContent.trim(),
                cells[4].textContent.trim(),
                cells[5].textContent.trim()
            ];
            csv += data.join(',') + '\n';
        }
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'rapport_inventaire_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}